<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>KST: Kaitai Struct Tests</title>
<link rel="stylesheet" href="styles/bootstrap.min.css">
<link rel="stylesheet" href="styles/bootstrap-theme.min.css">
<link rel="stylesheet" href="styles/main.css">
<link rel="stylesheet" href="./styles/colony.css">
</head>
<body class="article">
    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class=""><a href="//kaitai.io/#what-is-it">What is it?</a></li>
                    <li class=""><a href="//kaitai.io/#quick-start">Quick Start</a></li>
                    <li class=""><a href="//kaitai.io/#download">Download</a></li>
                    <li class=""><a href="//formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="//kaitai.io/repl/index.html">Try it</a></li>
                    <li><a href="https://ide.kaitai.io/">Web IDE</a></li>
                    <li class="active"><a href="index.html">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<div id="header">
<h1>KST: Kaitai Struct Tests</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Traditionally, testing Kaitai Struct relied on running specs which
do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for every target language</p>
</li>
<li>
<p>given:</p>
<div class="ulist">
<ul>
<li>
<p>an input binary file,</p>
</li>
<li>
<p>a library generated by Kaitai Struct Compiler for that target
language</p>
</li>
</ul>
</div>
</li>
<li>
<p>we run library&#8217;s parsing procedure on an input file, getting
ourselves some structure in memory with the parsed contents of input
file</p>
</li>
<li>
<p>finally, we compare the actual results of parsing with expected
result: we take certain key members of structure in memory and
assert that they should be equal to what we expect, or within
certain boundaries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While the procedure itself is solid, it quickly becomes very
labor-intensive to support that, as number of languages that KS
supports grows. Adding a new test now requires addition of ~10-12
per-language spec files, and doing that manually is both inefficient
and error-prone.</p>
</div>
<div class="paragraph">
<p>The solution for that comes from Kaitai Struct compiler itself: we
already have an expression language that might be used to address
structures in memory, so why not use that to generate test specs as
well?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kst_format">KST format</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cross-language test specs are described in KST (=Kaitai Struct Test)
format, which is also a YAML-based format, similar to KSY.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">id: foo_bar
data: expr_array.bin
asserts:
  - actual: aint_size
    expected: 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> is a name of a test spec, which MUST match exactly the name of
a KSY file in
<a href="https://github.com/kaitai-io/kaitai_struct_tests/tree/master/formats">formats</a>
dir.</p>
</li>
<li>
<p><code>data</code> is the name of input binary datafile, which MUST be present
in
<a href="https://github.com/kaitai-io/kaitai_struct_tests/tree/master/src">src</a>
dir; by convention, we use ".bin" file extension for all these files.</p>
</li>
<li>
<p><code>asserts</code> is a sequence of assertions that we&#8217;ll use to check that
contents of parsed structure in memory match our expectations. Every
assertion has two parts:</p>
</li>
<li>
<p><code>actual</code> is a KS expression, executed in context of root element
of KSY file that we&#8217;re tested, used to extract a certain member of
structure in memory to check.</p>
</li>
<li>
<p><code>expected</code> is normally some constant that we expect it to match
(but it is also a KS expression, so technically it can be
non-constant).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assertions are expected to be fatal (i.e. first failed assertion stops
the test process) and are specifically executed in sequence in
specified in <code>asserts</code>.</p>
</div>
<div class="paragraph">
<p>This file must be saved as <code>foo_bar.kst</code> (i.e. name MUST match the
<code>id</code> and the name of relevant .ksy file) in
<a href="https://github.com/kaitai-io/kaitai_struct_tests/tree/master/spec/ks">spec/ks</a>
dir.</p>
</div>
<div class="paragraph">
<p>When test is expected to fail with an exception, a slightly different
KST file is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">id: valid_fail_contents
data: fixed_struct.bin
exception: ValidationNotEqualError&lt;bytes&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>No <code>asserts</code> are present in this case, but there is a top-level
<code>exception</code> element, which lists the expected exception to be raised
during the parsing stage of this test. Available exception names are
listed in
<a href="https://github.com/kaitai-io/kaitai_struct_compiler/blob/master/shared/src/main/scala/io/kaitai/struct/datatype/KSError.scala">KSError.scala</a>
in kaitai-struct-compiler.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoking_kst_translator">Invoking KST translator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To make use of KST specs, they need to be translated into actual
target languages (just like KSY gets compiler into target languages),
so there is a translator project to do that.</p>
</div>
<div class="paragraph">
<p>KST translator is heavily based of kaitai-struct-compiler, so one
needs to compile and publish .jar files with kaitai-struct-compiler to
local repository first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># assuming we're in root project directory
cd compiler
sbt publishLocal</code></pre>
</div>
</div>
<div class="paragraph">
<p>after that, one can invoke it using
<a href="https://github.com/kaitai-io/kaitai_struct_tests/blob/master/spec_kst_to_all">spec_kst_to_all</a>
script in tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KST translator 0.9
Usage: kst_translator [options] [&lt;test_name&gt;...]

  &lt;test_name&gt;...           source test names (.kst)
  -t, --target &lt;language&gt;  target languages (construct, cpp_stl_98, cpp_stl_11, csharp, go, java, javascript, nim, perl, php, python, ruby, rust, default: all)
  --all-specs              process all KST files available
  -f, --force              force overwrite specs in production spec dirs (default: generate in ../spec/ks/out)</pre>
</div>
</div>
<div class="paragraph">
<p>For example, to generate specs in all possible target languages right
in the all relevant dirs for one KST spec "foo_bar", one can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">cd ../tests
./spec_kst_to_all -f foo_bar</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_developing_kst_translator">Developing KST translator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>

    <div id="footer">
            &copy; 2015-2019 Kaitai Project
    </div>
    <script src="js/jquery-1.12.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-76299550-1', 'auto');
        ga('send', 'pageview');
    </script>
</body>
</html>
