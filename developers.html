<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Kaitai Project">
<title>Developers memo</title>
<link rel="stylesheet" href="styles/bootstrap.min.css">
<link rel="stylesheet" href="styles/bootstrap-theme.min.css">
<link rel="stylesheet" href="styles/main.css">
<link rel="stylesheet" href="./styles/colony.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class=""><a href="http://kaitai.io/#what-is-it">What is it?</a></li>
                    <li class=""><a href="http://kaitai.io/#quick-start">Quick Start</a></li>
                    <li class=""><a href="http://kaitai.io/#download">Download</a></li>
                    <li class=""><a href="http://formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://kaitai.io/repl/index.html">Try it</a></li>
                    <li class="active"><a href="index.html">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<div id="header">
<h1>Developers memo</h1>
<div class="details">
<span id="author" class="author">Kaitai Project</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_compiler">Compiler</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_building_for_jvm">Building for JVM</a></li>
<li><a href="#_building_for_javascript_platform">Building for JavaScript platform</a></li>
<li><a href="#_publishing_a_new_version">Publishing a new version</a></li>
</ul>
</li>
<li><a href="#_tests">Tests</a></li>
<li><a href="#_runtimes">Runtimes</a>
<ul class="sectlevel2">
<li><a href="#_java">Java</a></li>
<li><a href="#_python">Python</a></li>
<li><a href="#_ruby">Ruby</a></li>
</ul>
</li>
<li><a href="#_adding_new_language">Adding new language</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>KS project consists of several subprojects, each of which has its own
repository:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct_compiler">compiler</a> —
everything starts here, this is the core of the project that
everything uses</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct_tests">tests</a> — used to
prove that compiler behaves as expected and there are no regressions
introduced by the changes</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct/tree/master/runtime">runtimes</a>,
one per each target language — used by the code generated by a
compiler</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct_doc">documentation</a> —
keeps users informed about the language and all new features</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct_visualizer">console
visualizer and tools: ksv, ksdump</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Technically, one can download and work with each of these subprojects
individually, but most people just download everything by checking out
<a href="https://github.com/kaitai_struct">our main umbrella project</a> that
includes (almost) everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git clone --recursive https://github.com/kaitai-io/kaitai_struct.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>--recursive</code> option, which would download all the
submodules. If you forgot it and cloned without it, you can still do
it manually after cloning:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git submodule update --init --recursive</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compiler">Compiler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KS compiler is written in <a href="http://www.scala-lang.org/">Scala language</a>
and thus uses <a href="http://www.scala-sbt.org/">SBT</a> for building. It can be
compiled in one of 2 ways, each of which can be packaged in one of
several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>generating Java <code>.class</code> files, to be run in JVM</p>
<div class="ulist">
<ul>
<li>
<p>not packaged, ready to be ran from a build dir (so called "stage
build")</p>
</li>
<li>
<p>packaged as universal (.zip) package</p>
</li>
<li>
<p>packaged as Debian (.deb) package</p>
</li>
<li>
<p>packaged as Windows (.msi) installer package</p>
</li>
</ul>
</div>
</li>
<li>
<p>generating JavaScript <code>.js</code> file, to be run either inside a browser
or in node.js environment</p>
<div class="ulist">
<ul>
<li>
<p>not packaged, used as a source JS file on a website</p>
</li>
<li>
<p>packaged as <a href="http://npmjs.org">npm</a> package</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="paragraph">
<p>To build the compiler, one generally needs just these two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java Runtime Environment (JRE)</p>
</li>
<li>
<p>Scala Build Tool (sbt)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Debian/Ubuntu, this should be enough to download every
prerequisite (JRE is pulled automatically by sbt):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">echo &quot;deb https://dl.bintray.com/sbt/debian /&quot; | sudo tee -a /etc/apt/sources.list.d/sbt.list
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2EE0EA64E40A89B84B2DF73499E82A75642AC823
sudo apt-get update
sudo apt-get install sbt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manual installation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.java.com/en/download/">Download JRE from official site</a></p>
</li>
<li>
<p><a href="https://www.scala-sbt.org/download.html">Download sbt from official site</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You don&#8217;t need whole Java Development Kit (JDK), unless you want
to test &amp; develop for Java target — just JRE is enough for KS
compiler.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All other dependencies (including Scala runtimes, compilers, etc)
required for <strong>the compiler</strong> are downloaded and installed by sbt
automatically. It shouldn&#8217;t really matter even which version of sbt
you use for bootstrap, as sbt will pull relevant sbt update packages
automatically as well.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_for_jvm">Building for JVM</h3>
<div class="paragraph">
<p>We use <a href="http://www.scala-sbt.org/sbt-native-packager/">sbt-native-packager</a> to
build deployable formats.</p>
</div>
<div class="sect3">
<h4 id="_building_an_universal_zip_package">Building an universal (.zip) package</h4>
<div class="paragraph">
<p><a href="http://www.scala-sbt.org/sbt-native-packager/formats/universal.html">SBT native packager: universal package docs</a></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>sbt compilerJVM/universal:packageBin</code></p>
</li>
<li>
<p>Get result in <code>jvm/target/universal/kaitai-struct-compiler-*.zip</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_building_a_href_http_www_scala_sbt_org_sbt_native_packager_formats_debian_html_debian_package_a">Building <a href="http://www.scala-sbt.org/sbt-native-packager/formats/debian.html">Debian package</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install prerequisites: <code>sudo -i apt-get install dpkg dpkg-sig dpkg-dev lintian fakeroot</code></p>
</li>
<li>
<p><code>sbt compilerJVM/debian:packageBin</code></p>
</li>
<li>
<p>Get result in <code>jvm/target/kaitai-struct-compiler_*_all.deb</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_building_windows_package">Building Windows package</h4>
<div class="paragraph">
<p><a href="http://www.scala-sbt.org/sbt-native-packager/formats/windows.html">SBT native packager: Windows package docs</a></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install WIX</p>
</li>
<li>
<p><code>sbt compilerJVM/windows:packageBin</code></p>
</li>
<li>
<p>Get result in <code>jvm/target/windows/kaitai-struct-compiler.msi</code></p>
</li>
<li>
<p>Rename to add version to <code>kaitai-struct-compiler-$VERSION.msi</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_for_javascript_platform">Building for JavaScript platform</h3>
<div class="paragraph">
<p>Building to JavaScript platform is done using a Scala.js project. Note
that it uses a somewhat different set of dependencies, as they must
actually be JavaScript libraries, not Java jars.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run <code>sbt fastOptJS</code></p>
</li>
<li>
<p>Get result in <code>js/target/scala-2.11/kaitai-struct-compiler-fastopt.js</code></p>
</li>
<li>
<p>Use this JavaScript file on a website</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_publishing_a_new_version">Publishing a new version</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Choose a new version number (WIX imposes harsh requirements for
version to look like <code>x.x.x.x</code>) and update it in <code>build.sbt</code>,
<code>version := &#8230;&#8203;</code>, commit</p>
</li>
<li>
<p>Prepare an entry in RELEASE_NOTES.md, commit</p>
</li>
<li>
<p>Create version tag:</p>
<div class="ulist">
<ul>
<li>
<p><code>git tag $VERSION</code></p>
</li>
<li>
<p><code>git push --tags</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Update [main repository](<a href="https://github.com/kaitai-io/kaitai_struct" class="bare">https://github.com/kaitai-io/kaitai_struct</a>)</p>
</li>
<li>
<p>Create new version at:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://bintray.com/kaitai-io/debian/kaitai-struct-compiler/new/version" class="bare">https://bintray.com/kaitai-io/debian/kaitai-struct-compiler/new/version</a></p>
</li>
<li>
<p><a href="https://bintray.com/kaitai-io/universal/kaitai-struct-compiler/new/version" class="bare">https://bintray.com/kaitai-io/universal/kaitai-struct-compiler/new/version</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Upload:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://bintray.com/kaitai-io/debian/kaitai-struct-compiler/$VERSION/upload" class="bare">https://bintray.com/kaitai-io/debian/kaitai-struct-compiler/$VERSION/upload</a></p>
<div class="ulist">
<ul>
<li>
<p>Debian distribution: <code>jessie</code></p>
</li>
<li>
<p>Debian component: <code>main</code></p>
</li>
<li>
<p>Debian architecture: <code>all</code></p>
</li>
<li>
<p>Attached file: <code>jvm/target/kaitai-struct-compiler_*_all.deb</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://bintray.com/kaitai-io/universal/kaitai-struct-compiler/$VERSION/upload" class="bare">https://bintray.com/kaitai-io/universal/kaitai-struct-compiler/$VERSION/upload</a></p>
<div class="ulist">
<ul>
<li>
<p>Target path: <code>$VERSION</code></p>
</li>
<li>
<p>Attached file: <code>jvm/target/universal/kaitai-struct-compiler-*.zip</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://bintray.com/kaitai-io/universal/kaitai-struct-compiler/$VERSION/upload" class="bare">https://bintray.com/kaitai-io/universal/kaitai-struct-compiler/$VERSION/upload</a></p>
<div class="ulist">
<ul>
<li>
<p>Target path: <code>$VERSION</code></p>
</li>
<li>
<p>Attached file: <code>jvm/target/windows/kaitai-struct-compiler-*.msi</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Publish them all</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tests">Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_runtimes">Runtimes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_java">Java</h3>
<div class="sect3">
<h4 id="_publishing">Publishing</h4>
<div class="ulist">
<ul>
<li>
<p>Pump version, set version to <code>$VERSION</code>, without <code>-SNAPSHOT</code></p>
</li>
<li>
<p><code>mvn deploy</code></p>
</li>
<li>
<p>Go to <a href="https://oss.sonatype.org/#stagingRepositories" class="bare">https://oss.sonatype.org/#stagingRepositories</a></p>
</li>
<li>
<p>Scroll to the very end of list, seek <code>iokaitai-&#8230;&#8203;</code> repositories</p>
</li>
<li>
<p>Select our staging repository</p>
</li>
<li>
<p>Press "Close" toolbar button</p>
<div class="ulist">
<ul>
<li>
<p>Confirm</p>
</li>
<li>
<p>Wait for checks to complete</p>
</li>
</ul>
</div>
</li>
<li>
<p>Press "Release" toolbar button</p>
<div class="ulist">
<ul>
<li>
<p>Enter release message</p>
</li>
<li>
<p>Confirm</p>
</li>
</ul>
</div>
</li>
<li>
<p>After some time, check <a href="https://search.maven.org/#search%7Cga%7C1%7Ca%3A%22kaitai-struct-runtime%22" class="bare">https://search.maven.org/#search%7Cga%7C1%7Ca%3A%22kaitai-struct-runtime%22</a> to have new version</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_python">Python</h3>
<div class="sect3">
<h4 id="_publishing_2">Publishing</h4>
<div class="ulist">
<ul>
<li>
<p>Pump version in <code>kaitaistruct.py</code>, seek <code><em>version</em> =</code></p>
</li>
<li>
<p><code>python3 setup.py sdist upload</code></p>
<div class="ulist">
<ul>
<li>
<p>(use <code>python3 setup.py sdist upload -r pypitest</code> to publish to testing server)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Check that new version appears at <a href="https://pypi.python.org/pypi/kaitaistruct/$VERSION" class="bare">https://pypi.python.org/pypi/kaitaistruct/$VERSION</a></p>
</li>
<li>
<p><code>git tag $VERSION</code></p>
</li>
<li>
<p><code>git push --tags</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ruby">Ruby</h3>
<div class="sect3">
<h4 id="_publishing_3">Publishing</h4>
<div class="ulist">
<ul>
<li>
<p>Pump version in <code>lib/kaitai/struct/struct.rb</code>, seek `VERSION = `</p>
</li>
<li>
<p><code>gem build kaitai-struct.gemspec</code></p>
</li>
<li>
<p>Test gem (i.e. by installing it to a live system)</p>
</li>
<li>
<p><code>gem push kaitai-struct-$VERSION.gem</code></p>
</li>
<li>
<p><code>git tag $VERSION</code></p>
</li>
<li>
<p><code>git push --tags</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_new_language">Adding new language</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Overall routine for adding new language is described in
<a href="new_language.html">Adding support for new target language</a>.</p>
</div>
<div class="paragraph">
<p>After addition, don&#8217;t forget to update lists of languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>/build.sbt - supportedLanguages</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct" class="bare">https://github.com/kaitai-io/kaitai_struct</a> — project description</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct_compiler" class="bare">https://github.com/kaitai-io/kaitai_struct_compiler</a> — project description</p>
</li>
<li>
<p><a href="https://github.com/kaitai-io/kaitai_struct_compiler/blob/master/README.md" class="bare">https://github.com/kaitai-io/kaitai_struct_compiler/blob/master/README.md</a> — <code>-t</code> option documentation</p>
</li>
<li>
<p><a href="http://kaitai.io" class="bare">http://kaitai.io</a> — everywhere</p>
</li>
<li>
<p><a href="https://bintray.com/kaitai-io/debian/kaitai-struct-compiler/view" class="bare">https://bintray.com/kaitai-io/debian/kaitai-struct-compiler/view</a> — package description</p>
</li>
<li>
<p><a href="https://twitter.com/kaitai_io" class="bare">https://twitter.com/kaitai_io</a> — profile</p>
</li>
</ul>
</div>
</div>
</div>
</div>

    <div id="footer">
            &copy; 2015-2017 Kaitai Project
    </div>
    <script src="js/jquery-1.12.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
        ga('create', 'UA-76299550-1', 'auto');
        ga('send', 'pageview');
    </script>
</body>
</html>
